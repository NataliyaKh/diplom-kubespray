---
- name: Fix network configuration for internet access
  hosts: all
  gather_facts: true
  become: true
  become_user: root
  tasks:
    - name: Check current network state
      shell: |
        echo "=== IP Address ==="
        ip addr show eth0
        echo "=== Routing Table ==="
        ip route show
        echo "=== DNS ==="
        cat /etc/resolv.conf
        echo "=== Default Gateway ==="
        ip route | grep default || echo "No default route found"
      register: network_state

    - name: Show network state
      debug:
        var: network_state.stdout

    - name: Configure proper DNS
      copy:
        content: |
          nameserver 8.8.8.8
          nameserver 1.1.1.1
          nameserver 77.88.8.8
        dest: /etc/resolv.conf

    - name: Add default route if missing
      shell: |
        SUBNET=$(ip route | grep -oP '10\.0\.[0-9]+\.[0-9]+/[0-9]+' | head -1)
        GATEWAY="${SUBNET%.*}.1"
        ip route add default via $GATEWAY dev eth0 || true
      ignore_errors: yes

    - name: Test internet connectivity
      shell: |
        echo "Testing connectivity to 8.8.8.8..."
        ping -c 2 -W 1 8.8.8.8 && echo "PING_SUCCESS" || echo "PING_FAILED"
        echo "Testing DNS..."
        nslookup google.com && echo "DNS_SUCCESS" || echo "DNS_FAILED"
        echo "Testing HTTP..."
        curl -I --connect-timeout 5 http://google.com && echo "HTTP_SUCCESS" || echo "HTTP_FAILED"
      register: connectivity
      ignore_errors: true

    - name: Show connectivity results
      debug:
        var: connectivity.stdout
