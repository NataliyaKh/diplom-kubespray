---
- name: Fix kube-apiserver certificate with missing external IP
  hosts: kube_control_plane
  become: true
  become_user: root
  vars:
    external_ips: "{{ groups['kube_control_plane'] | map('extract', hostvars, 'ansible_host') | list }}"
    internal_ips: "{{ groups['kube_control_plane'] | map('extract', hostvars, 'ip') | list }}"
    cert_sans: >-
      {{
        [
          '127.0.0.1',
          'localhost',
          'kubernetes',
          'kubernetes.default',
          'kubernetes.default.svc',
          'kubernetes.default.svc.cluster.local',
          '10.233.0.1'
        ] +
        external_ips +
        internal_ips
      | unique }}
  tasks:
    - name: Show certificate SANs that will be added
      debug:
        var: cert_sans

    - name: Backup current PKI
      command: cp -r /etc/kubernetes/pki /etc/kubernetes/pki.backup-fix
      args:
        creates: /etc/kubernetes/pki.backup-fix

    - name: Create kubeadm config with correct SANs
      copy:
        dest: /root/kubeadm-config.yaml
        content: |
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: ClusterConfiguration
          kubernetesVersion: v1.27.9
          controlPlaneEndpoint: "kubernetes:6443"
          apiServer:
            certSANs:
            {% for ip in cert_sans %}
            - "{{ ip }}"
            {% endfor %}
          networking:
            serviceSubnet: 10.233.0.0/18
            podSubnet: 10.233.64.0/18

    - name: Check current apiserver certificate SANs
      shell: |
        openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep -A 10 "X509v3 Subject Alternative Name"
      register: current_sans
      changed_when: false

    - name: Show current SANs
      debug:
        var: current_sans.stdout

    - name: Remove old apiserver certificates
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes/pki/apiserver.crt
        - /etc/kubernetes/pki/apiserver.key

    - name: Regenerate apiserver certificate
      command: kubeadm init phase certs apiserver --config /root/kubeadm-config.yaml
      args:
        chdir: /etc/kubernetes

    - name: Restart kube-apiserver pod
      command: kubectl delete pod -l component=kube-apiserver -n kube-system
      ignore_errors: true

    - name: Wait for API server
      wait_for:
        port: 6443
        host: "{{ ansible_default_ipv4.address }}"
        delay: 10
        timeout: 120

    - name: Verify new certificate SANs
      shell: |
        openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep -A 10 "X509v3 Subject Alternative Name"
      register: new_sans
      changed_when: false

    - name: Show new SANs
      debug:
        var: new_sans.stdout

    - name: Regenerate admin.conf
      command: kubeadm init phase kubeconfig admin --config /root/kubeadm-config.yaml

    - name: Test local access
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes
      register: local_test
      changed_when: false

    - name: Show local test result
      debug:
        var: local_test.stdout
